<!DOCTYPE html>
<html lang="fr" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>MSE OS v10 | Fusion Mode</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        /* --- SYST√àME DE VARIABLES DYNAMIQUE --- */
        :root {
            /* Mode Sombre (D√©faut) */
            --bg: #000000;
            --surface: #121214;
            --card: #1c1c1e;
            --text: #ffffff;
            --text-dim: #888888;
            --border: rgba(255, 255, 255, 0.1);
            --gold: #D4AF37;
            --blue: #3e82f7;
            --green: #32d74b;
            --red: #ff453a;
        }

        [data-theme="light"] {
            /* Mode Clair */
            --bg: #f2f2f7;
            --surface: #ffffff;
            --card: #ffffff;
            --text: #000000;
            --text-dim: #666666;
            --border: rgba(0, 0, 0, 0.05);
            /* Les couleurs d'accent restent identiques pour l'image de marque */
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; transition: background 0.3s, color 0.3s; }
        
        body { 
            margin: 0; background: var(--bg); color: var(--text); 
            height: 100vh; overflow: hidden; display: flex; flex-direction: column;
        }

        /* --- HEADER & THEME TOGGLE --- */
        .home-header {
            padding: calc(env(safe-area-inset-top) + 20px) 25px 20px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .theme-toggle {
            width: 45px; height: 45px; border-radius: 50%;
            background: var(--surface); border: 1px solid var(--border);
            display: flex; align-items: center; justify-content: center;
            font-size: 20px; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        /* --- DASHBOARD GRID --- */
        #home-screen {
            padding: 0 25px 120px;
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 25px 15px;
            overflow-y: auto; height: 100%; align-content: start;
        }
        .section-label { grid-column: span 4; font-size: 11px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1px; margin: 15px 0 5px; }

        .app-item { display: flex; flex-direction: column; align-items: center; cursor: pointer; }
        .squircle {
            width: 62px; height: 62px; border-radius: 22px; display: flex; align-items: center; justify-content: center;
            font-size: 28px; box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }
        .squircle:active { transform: scale(0.88); }
        .app-label { margin-top: 8px; font-size: 10px; font-weight: 600; color: var(--text-dim); text-align: center; line-height: 1.2; }

        /* Gradients One UI */
        .g-gold { background: linear-gradient(135deg, #d4af37, #967a2a); color: #000; }
        .g-blue { background: linear-gradient(135deg, #3e82f7, #1a4fa3); color: #fff; }
        .g-green { background: linear-gradient(135deg, #32d74b, #1d8a2d); color: #fff; }
        .g-red { background: linear-gradient(135deg, #ff453a, #c0392b); color: #fff; }
        .g-util { background: var(--surface); border: 1px solid var(--border); }

        /* --- WINDOW SYSTEM --- */
        .window {
            position: fixed; inset: 0; background: var(--bg); z-index: 1000;
            display: none; flex-direction: column; animation: app-open 0.4s cubic-bezier(0, 0, 0.2, 1);
        }
        @keyframes app-open { from { transform: scale(0.95) translateY(20px); opacity: 0; } to { transform: scale(1) translateY(0); opacity: 1; } }
        
        .win-header { padding: calc(env(safe-area-inset-top) + 15px) 25px 15px; display: flex; align-items: center; justify-content: space-between; background: var(--bg); border-bottom: 1px solid var(--border); }
        .content { flex: 1; overflow-y: auto; padding: 20px 20px 150px; }
        .one-card { background: var(--surface); border-radius: 28px; padding: 20px; margin-bottom: 16px; border: 1px solid var(--border); }
        .one-card h3 { font-size: 11px; color: var(--gold); text-transform: uppercase; margin: 0 0 15px; letter-spacing: 1px; }

        input, textarea, select {
            width: 100%; background: var(--bg); border: 1px solid var(--border);
            border-radius: 14px; padding: 15px; color: var(--text); font-size: 16px; margin-bottom: 12px;
        }

        /* --- PDF RENDERING (FORC√â BLANC) --- */
        #preview-overlay { display: none; position: fixed; inset: 0; background: #000; z-index: 2000; flex-direction: column; }
        #pdf-paper { background: white !important; color: black !important; width: 100%; min-height: 100%; }

        /* --- DOCK --- */
        .dock {
            position: fixed; bottom: 0; width: 100%; padding: 20px 25px calc(env(safe-area-inset-bottom) + 20px);
            background: var(--surface); backdrop-filter: blur(20px); border-top: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
        }
        .btn-main { background: var(--gold); color: #000; border: none; padding: 16px 30px; border-radius: 18px; font-weight: 800; cursor: pointer; }
    </style>
</head>
<body>

    <div class="home-header">
        <div>
            <h1 style="margin:0; font-size: 28px; font-weight: 900;">MSE OS</h1>
            <p style="margin:0; font-size: 12px; color: var(--gold); font-weight: 700;">PRO SUITE v10</p>
        </div>
        <div class="theme-toggle" onclick="toggleTheme()" id="theme-btn">üåô</div>
    </div>

    <div id="home-screen">
        <div class="section-label">Facturation Premium</div>
        <div class="app-item" onclick="openApp('DEVIS', 'standard')"><div class="squircle g-gold">üìù</div><div class="app-label">Devis<br>20%</div></div>
        <div class="app-item" onclick="openApp('FACTURE', 'standard')"><div class="squircle g-gold">üí∞</div><div class="app-label">Facture<br>20%</div></div>
        <div class="app-item" onclick="openApp('ACQUITT√âE', 'standard')"><div class="squircle g-green">‚úÖ</div><div class="app-label">Acquitt√©e</div></div>

        <div class="section-label">R√©gime Micro</div>
        <div class="app-item" onclick="openApp('DEVIS', 'micro')"><div class="squircle g-blue">üìÑ</div><div class="app-label">Devis<br>Net</div></div>
        <div class="app-item" onclick="openApp('FACTURE', 'micro')"><div class="squircle g-blue">ü™ô</div><div class="app-label">Facture<br>Net</div></div>

        <div class="section-label">Gestion & Outils</div>
        <div class="app-item" onclick="alert('Clients')"><div class="squircle g-util">üë•</div><div class="app-label">Clients</div></div>
        <div class="app-item" onclick="alert('Compta')"><div class="squircle g-util">‚öñÔ∏è</div><div class="app-label">Compta</div></div>
        <div class="app-item" onclick="alert('Urssaf')"><div class="squircle g-red">üèõÔ∏è</div><div class="app-label">Urssaf</div></div>
    </div>

    <div id="app-window" class="window">
        <div class="win-header">
            <div onclick="closeApp()" style="font-size: 24px; cursor: pointer;">‚úï</div>
            <h2 id="win-title" style="margin:0; font-size: 18px;">EDITEUR</h2>
            <div style="width: 24px;"></div>
        </div>
        <div class="content" id="win-content">
            </div>
        <div class="dock">
            <div>
                <div id="dock-label" style="font-size: 10px; opacity: 0.6;">NET √Ä PAYER</div>
                <div id="dock-val" style="font-size: 22px; font-weight: 900; color: var(--gold);">0.00 ‚Ç¨</div>
            </div>
            <button class="btn-main" onclick="generatePDF()">G√©n√©rer</button>
        </div>
    </div>

    <div id="preview-overlay">
        <div style="padding: 60px 20px 20px; display:flex; gap:12px; background:#000;">
            <button onclick="document.getElementById('preview-overlay').style.display='none'" style="background:#252528; color:white; border:none; padding:15px; border-radius:18px; flex:1">Retour</button>
            <button class="btn-main" style="flex:2" onclick="downloadPDF()">T√©l√©charger HD</button>
        </div>
        <div style="flex:1; overflow-y:auto; padding:10px; background:#333;"><div id="pdf-paper"></div></div>
    </div>

    <script>
        let currentMode = "standard";
        let currentType = "FACTURE";

        // --- GESTION DU TH√àME ---
        function toggleTheme() {
            const html = document.documentElement;
            const btn = document.getElementById('theme-btn');
            if (html.getAttribute('data-theme') === 'dark') {
                html.setAttribute('data-theme', 'light');
                btn.innerText = '‚òÄÔ∏è';
            } else {
                html.setAttribute('data-theme', 'dark');
                btn.innerText = 'üåô';
            }
        }

        // --- GESTION DES APPS ---
        function openApp(type, mode) {
            currentType = type;
            currentMode = mode;
            document.getElementById('app-window').style.display = 'flex';
            document.getElementById('win-title').innerText = type + (mode === 'micro' ? ' MICRO' : '');
            renderEditor();
        }

        function closeApp() { document.getElementById('app-window').style.display = 'none'; }

        function renderEditor() {
            const cont = document.getElementById('win-content');
            const isMicro = (currentMode === 'micro');
            cont.innerHTML = `
                <div class="one-card">
                    <h3>Infos Dossier</h3>
                    <input type="text" id="doc-num" placeholder="Num√©ro Document">
                    <input type="text" id="doc-obj" placeholder="Objet de l'intervention">
                </div>
                <div class="one-card">
                    <h3>Client</h3>
                    <input type="text" id="c-name" placeholder="Nom du Client">
                    <textarea id="c-addr" placeholder="Adresse compl√®te" rows="2"></textarea>
                    <div style="display:flex; align-items:center; gap:10px; margin-top:10px;">
                        <input type="checkbox" id="ref-check" style="width:20px; height:20px; margin:0;" onchange="document.getElementById('c-ref').style.display = this.checked ? 'block' : 'none'">
                        <label style="font-size:12px;">Ajouter R√©f√©rence ?</label>
                    </div>
                    <input type="text" id="c-ref" placeholder="R√©f. Assurance / Syndic" style="display:none; margin-top:10px;">
                </div>
                <div class="one-card">
                    <h3>Prestations</h3>
                    <div id="items-list"></div>
                    <button onclick="addLine()" style="background:var(--border); border:none; color:var(--text); width:100%; padding:15px; border-radius:14px;">+ Ligne</button>
                </div>
            `;
            addLine();
        }

        function addLine() {
            const id = Date.now();
            const div = document.createElement('div');
            div.style.marginBottom = '20px';
            div.innerHTML = `
                <input type="text" placeholder="Titre (Gras)" style="font-weight:bold;" class="l-n">
                <textarea placeholder="D√©tails (Italique fin)" style="font-style:italic; font-size:13px; opacity:0.7;" class="l-d"></textarea>
                <div style="display:flex; gap:10px;">
                    <input type="number" value="1" style="flex:1" class="l-q" oninput="updateTotal()">
                    <input type="number" placeholder="Prix" style="flex:2" class="l-p" oninput="updateTotal()">
                </div>
            `;
            document.getElementById('items-list').appendChild(div);
        }

        function updateTotal() {
            let ht = 0;
            document.querySelectorAll('#items-list > div').forEach(div => {
                ht += (div.querySelector('.l-q').value * div.querySelector('.l-p').value);
            });
            const ttc = (currentMode === 'standard') ? ht * 1.2 : ht;
            document.getElementById('dock-val').innerText = ttc.toFixed(2) + ' ‚Ç¨';
            return { ht, ttc };
        }

        function generatePDF() {
            const data = updateTotal();
            const date = new Date().toLocaleDateString('fr-FR');
            let rows = "";
            document.querySelectorAll('#items-list > div').forEach(div => {
                const n = div.querySelector('.l-n').value;
                const d = div.querySelector('.l-d').value;
                const q = div.querySelector('.l-q').value;
                const p = div.querySelector('.l-p').value;
                rows += `
                    <tr>
                        <td style="padding:15px; border-bottom:1px solid #eee;">
                            <div style="font-weight:bold; font-size:14px;">${n}</div>
                            <div style="font-style:italic; font-size:10px; color:#555;">${d}</div>
                        </td>
                        <td style="text-align:center">${q}</td>
                        <td style="text-align:right">${parseFloat(p).toFixed(2)}‚Ç¨</td>
                        <td style="text-align:right">${(q*p).toFixed(2)}‚Ç¨</td>
                    </tr>`;
            });

            const acquit = currentType === 'ACQUITT√âE' ? '<div style="border:4px solid red; color:red; padding:10px; position:absolute; top:150px; right:50px; transform:rotate(-15deg); font-weight:900; font-size:24px;">ACQUITT√âE</div>' : '';

            document.getElementById('pdf-paper').innerHTML = `
                <div style="padding:40px; position:relative;">
                    ${acquit}
                    <div style="display:flex; justify-content:space-between; border-bottom:4px solid ${currentMode==='standard'?'#D4AF37':'#3e82f7'}; padding-bottom:15px;">
                        <div><strong style="font-size:24px;">MSE</strong><br>Sabri BENNACEUR EI<br>2 R√©sidence des Rosiers, 92800 Puteaux</div>
                        <div style="text-align:right"><strong>${currentType} N¬∞ ${document.getElementById('doc-num').value}</strong><br>Date: ${date}</div>
                    </div>
                    <div style="margin:30px 0;">
                        <strong>CLIENT:</strong><br>${document.getElementById('c-name').value}<br>${document.getElementById('c-addr').value.replace(/\n/g,'<br>')}
                        ${document.getElementById('ref-check').checked ? '<br><strong>R√©f:</strong> ' + document.getElementById('c-ref').value : ''}
                    </div>
                    <table style="width:100%; border-collapse:collapse;">
                        <tr style="background:#f9f9f9;"><th>D√©signation</th><th>Qt√©</th><th>P.U</th><th>Total</th></tr>
                        ${rows}
                    </table>
                    <div style="float:right; width:220px; margin-top:30px;">
                        <table style="width:100%">
                            <tr><td>TOTAL ${currentMode==='standard'?'HT':''}</td><td style="text-align:right">${data.ht.toFixed(2)}‚Ç¨</td></tr>
                            ${currentMode==='standard' ? `<tr><td>TVA (20%)</td><td style="text-align:right">${(data.ht*0.2).toFixed(2)}‚Ç¨</td></tr>` : ''}
                            <tr style="font-size:18px; font-weight:bold; border-top:2px solid #000;"><td>${currentMode==='standard'?'TOTAL TTC':'NET √Ä PAYER'}</td><td style="text-align:right">${data.ttc.toFixed(2)}‚Ç¨</td></tr>
                        </table>
                    </div>
                </div>`;
            document.getElementById('preview-overlay').style.display = 'flex';
        }

        function downloadPDF() {
            const el = document.getElementById('pdf-paper');
            html2pdf().set({ margin:0, filename:'MSE_2026.pdf', html2canvas:{scale:3}, jsPDF:{format:'a4'} }).from(el).save();
        }
    </script>
</body>
</html>
