<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>MSE BUSINESS OS 2026</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root {
            --bg: #000; --surface: #121212; --gold: #D4AF37; --green: #2ECC71; --blue: #3498DB; --red: #E74C3C;
            --safe-top: env(safe-area-inset-top); --safe-bottom: env(safe-area-inset-bottom);
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: var(--bg); color: #fff; font-family: -apple-system, sans-serif; overflow: hidden; height: 100vh; }

        /* --- HOME SCREEN (GRID) --- */
        #home-screen {
            padding: calc(var(--safe-top) + 40px) 20px;
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px;
            overflow-y: auto; height: 100%; align-content: start;
        }
        .app-icon-wrapper { display: flex; flex-direction: column; align-items: center; cursor: pointer; }
        .app-icon {
            width: 65px; height: 65px; border-radius: 16px; margin-bottom: 8px;
            display: flex; align-items: center; justify-content: center; font-size: 30px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); transition: 0.2s;
        }
        .app-icon:active { transform: scale(0.9); opacity: 0.7; }
        .app-label { font-size: 10px; font-weight: 600; text-transform: uppercase; color: #aaa; text-align: center; }

        /* Icon Colors */
        .bg-gold { background: linear-gradient(135deg, #fceabb, #f8b500); }
        .bg-blue { background: linear-gradient(135deg, #00d2ff, #3a7bd5); }
        .bg-green { background: linear-gradient(135deg, #56ab2f, #a8e063); }
        .bg-red { background: linear-gradient(135deg, #cb2d3e, #ef473a); }
        .bg-purple { background: linear-gradient(135deg, #8e44ad, #c39bd3); }
        .bg-dark { background: #222; border: 1px solid #444; }

        /* --- APP VIEW CONTAINER --- */
        .app-window {
            position: fixed; inset: 0; background: var(--bg); z-index: 1000;
            display: none; flex-direction: column; animation: openApp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        @keyframes openApp { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .app-header {
            padding: calc(var(--safe-top) + 20px) 20px 15px;
            background: rgba(0,0,0,0.8); backdrop-filter: blur(20px);
            display: flex; align-items: center; border-bottom: 1px solid #222;
        }
        .close-btn { font-size: 24px; margin-right: 20px; color: var(--gold); }
        
        .app-content { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 100px; }

        /* --- UI COMPONENTS --- */
        .card { background: var(--surface); border-radius: 20px; padding: 20px; margin-bottom: 15px; border: 1px solid #222; }
        .card h3 { margin: 0 0 15px; font-size: 12px; color: var(--gold); letter-spacing: 1px; }
        
        input, select, textarea {
            width: 100%; background: #000; border: 1px solid #333; border-radius: 12px;
            padding: 15px; color: white; font-size: 16px; margin-bottom: 10px;
        }
        .btn-main {
            background: var(--gold); color: #000; border: none; padding: 18px;
            border-radius: 15px; font-weight: 800; width: 100%; cursor: pointer;
        }
        .stat-val { font-size: 28px; font-weight: 900; margin: 5px 0; }
        
        /* --- PDF PREVIEW --- */
        #preview-overlay { display: none; position: fixed; inset: 0; background: #000; z-index: 2000; flex-direction: column; }

        /* --- SPECIFIC APP STYLES --- */
        .expense-item { border-left: 4px solid var(--red); padding-left: 10px; margin-bottom: 10px; }
        .income-item { border-left: 4px solid var(--green); padding-left: 10px; margin-bottom: 10px; }
    </style>
</head>
<body>

    <div id="home-screen">
        <div class="app-icon-wrapper" onclick="openApp('app-devis')"><div class="app-icon bg-red">üìù</div><div class="app-label">Devis</div></div>
        <div class="app-icon-wrapper" onclick="openApp('app-facture')"><div class="app-icon bg-gold">üí∞</div><div class="app-label">Facture</div></div>
        <div class="app-icon-wrapper" onclick="openApp('app-clients')"><div class="app-icon bg-blue">üë•</div><div class="app-label">Clients</div></div>
        <div class="app-icon-wrapper" onclick="openApp('app-validated')"><div class="app-icon bg-green">‚úÖ</div><div class="app-label">Valid√©s</div></div>
        
        <div class="app-icon-wrapper" onclick="openApp('app-taxes')"><div class="app-icon bg-purple">üèõÔ∏è</div><div class="app-label">Urssaf</div></div>
        <div class="app-icon-wrapper" onclick="openApp('app-net')"><div class="app-icon bg-green">üíµ</div><div class="app-label">Net R√©el</div></div>
        <div class="app-icon-wrapper" onclick="openApp('app-expenses')"><div class="app-icon bg-red">üõí</div><div class="app-label">D√©penses</div></div>
        <div class="app-icon-wrapper" onclick="openApp('app-compta')"><div class="app-icon bg-dark">‚öñÔ∏è</div><div class="app-label">Compta</div></div>

        <div class="app-icon-wrapper" onclick="openApp('app-prices')"><div class="app-icon bg-dark">üè∑Ô∏è</div><div class="app-label">Tarifs</div></div>
        <div class="app-icon-wrapper" onclick="openApp('app-metr√©')"><div class="app-icon bg-blue">üìê</div><div class="app-label">M√©tr√©</div></div>
        <div class="app-icon-wrapper" onclick="openApp('app-address')"><div class="app-icon bg-gold">üìç</div><div class="app-label">Adresses</div></div>
        <div class="app-icon-wrapper" onclick="openApp('app-archive')"><div class="app-icon bg-dark">üìÇ</div><div class="app-label">Archives</div></div>
    </div>

    <div id="app-devis" class="app-window">
        <div class="app-header"><div class="close-btn" onclick="closeApp()">‚úï</div><h2>CR√âER DEVIS</h2></div>
        <div class="app-content">
            <div class="card">
                <h3>CLIENT & INFOS</h3>
                <input type="text" id="doc-num" placeholder="N¬∞ Document">
                <input type="text" id="c-name" placeholder="Nom Client">
                <textarea id="c-addr" placeholder="Adresse intervention"></textarea>
            </div>
            <div class="card">
                <h3>PRESTATIONS</h3>
                <div id="lines-container"></div>
                <button class="btn-main" style="background:#222; color:#fff;" onclick="addLine()">+ Ajouter Ligne</button>
            </div>
            <div class="card">
                <h3>TOTAL</h3>
                <div style="display:flex; justify-content:space-between;"><span>Total TTC</span><span id="total-val">0.00 ‚Ç¨</span></div>
            </div>
            <button class="btn-main" onclick="saveDoc('DEVIS')">G√âN√âRER PDF</button>
        </div>
    </div>

    <div id="app-taxes" class="app-window">
        <div class="app-header"><div class="close-btn" onclick="closeApp()">‚úï</div><h2>ESTIMATION TAXES</h2></div>
        <div class="app-content">
            <div class="card">
                <h3>URSSAF (Micro-entreprise 21.2%)</h3>
                <input type="number" id="tax-ca" placeholder="Chiffre d'Affaires HT" oninput="calcTax()">
                <div class="stat-val" id="tax-res" style="color:var(--red);">0.00 ‚Ç¨</div>
                <p style="font-size:10px; color:#666;">Bas√© sur le taux standard de prestation de service.</p>
            </div>
        </div>
    </div>

    <div id="app-compta" class="app-window">
        <div class="app-header"><div class="close-btn" onclick="closeApp()">‚úï</div><h2>COMPTABILIT√â</h2></div>
        <div class="app-content">
            <div class="card">
                <h3>BILAN MENSUEL</h3>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                    <div><label>REVENUS</label><div class="stat-val" style="color:var(--green);" id="compta-inc">0‚Ç¨</div></div>
                    <div><label>D√âPENSES</label><div class="stat-val" style="color:var(--red);" id="compta-exp">0‚Ç¨</div></div>
                </div>
                <hr style="border:0; border-top:1px solid #333; margin:15px 0;">
                <label>R√âSULTAT NET (B√©n√©fice)</label>
                <div class="stat-val" id="compta-net">0.00 ‚Ç¨</div>
            </div>
        </div>
    </div>

    <div id="app-expenses" class="app-window">
        <div class="app-header"><div class="close-btn" onclick="closeApp()">‚úï</div><h2>D√âPENSES</h2></div>
        <div class="app-content">
            <div class="card">
                <h3>AJOUTER UN ACHAT</h3>
                <input type="text" id="exp-label" placeholder="Ex: Peinture, Verrou, Carburant">
                <input type="number" id="exp-val" placeholder="Montant TTC">
                <button class="btn-main" onclick="addExpense()">ENREGISTRER</button>
            </div>
            <div id="expense-list"></div>
        </div>
    </div>

    <div id="app-validated" class="app-window">
        <div class="app-header"><div class="close-btn" onclick="closeApp()">‚úï</div><h2>DEVIS VALID√âS</h2></div>
        <div class="app-content">
            <div id="validated-stats" class="card">
                <h3>RENDEMENT DU MOIS</h3>
                <div class="stat-val" id="yield-total">0.00 ‚Ç¨</div>
                <p>Cumul des chantiers accept√©s.</p>
            </div>
            <div id="validated-list"></div>
        </div>
    </div>

    <div id="app-net" class="app-window">
        <div class="app-header"><div class="close-btn" onclick="closeApp()">‚úï</div><h2>NET APR√àS CHARGES</h2></div>
        <div class="app-content">
            <div class="card">
                <h3>QU'EST-CE QUI RESTE DANS MA POCHE ?</h3>
                <input type="number" id="net-total-invoice" placeholder="Montant Facture HT" oninput="calcNetReal()">
                <div style="margin:10px 0;">
                    <div style="display:flex; justify-content:space-between; font-size:12px;"><span>- URSSAF (21.2%)</span><span id="net-urssaf" color="red">0‚Ç¨</span></div>
                    <div style="display:flex; justify-content:space-between; font-size:12px;"><span>- Frais estim√©s (10%)</span><span id="net-frais">0‚Ç¨</span></div>
                </div>
                <label>NET R√âEL ESTIM√â</label>
                <div class="stat-val" style="color:var(--green)" id="net-real-res">0.00 ‚Ç¨</div>
            </div>
        </div>
    </div>

    <div id="preview-overlay">
        <div style="padding: 50px 20px 20px; display:flex; gap:10px; background:#000;">
            <button class="btn-main" style="background:#222; color:#fff;" onclick="closePreview()">RETOUR</button>
            <button class="btn-main" onclick="downloadPDF()">T√âL√âCHARGER</button>
        </div>
        <div id="pdf-render" style="flex:1; overflow-y:auto; padding:10px; background:#333;"><div id="pdf-paper" style="background:#fff; color:#000; width:100%; min-height:100%;"></div></div>
    </div>

    <script>
        // DB INITIALIZATION
        let DB = {
            docs: JSON.parse(localStorage.getItem('mse_docs') || '[]'),
            expenses: JSON.parse(localStorage.getItem('mse_expenses') || '[]'),
            clients: JSON.parse(localStorage.getItem('mse_clients') || '[]')
        };

        const USER = { name: "Sabri BENNACEUR EI", addr: "2 R√©sidence des Rosiers, 92800 Puteaux", siren: "943032755", iban: "FR76 1695 8000 0159 6810 0824 765" };

        function openApp(id) { document.getElementById(id).style.display = 'flex'; if(id==='app-compta') updateCompta(); if(id==='app-validated') updateYield(); }
        function closeApp() { document.querySelectorAll('.app-window').forEach(w => w.style.display = 'none'); }

        // --- GESTION DES LIGNES ---
        function addLine(n='', q=1, p='') {
            const id = Date.now();
            const div = document.createElement('div');
            div.className = 'card'; div.id = 'line-'+id;
            div.style.padding = '10px';
            div.innerHTML = `<input type="text" placeholder="Description" value="${n}" class="l-n"><div style="display:flex; gap:10px;"><input type="number" placeholder="Qt√©" value="${q}" class="l-q" oninput="updateTotal()"><input type="number" placeholder="P.U" value="${p}" class="l-p" oninput="updateTotal()"></div>`;
            document.getElementById('lines-container').appendChild(div);
        }

        function updateTotal() {
            let t = 0;
            document.querySelectorAll('#lines-container .card').forEach(c => {
                t += (c.querySelector('.l-q').value * c.querySelector('.l-p').value);
            });
            document.getElementById('total-val').innerText = (t * 1.2).toFixed(2) + ' ‚Ç¨';
        }

        // --- TAXES & NET ---
        function calcTax() {
            const ca = document.getElementById('tax-ca').value || 0;
            document.getElementById('tax-res').innerText = (ca * 0.212).toFixed(2) + ' ‚Ç¨';
        }

        function calcNetReal() {
            const ca = document.getElementById('net-total-invoice').value || 0;
            const urssaf = ca * 0.212;
            const frais = ca * 0.10;
            document.getElementById('net-urssaf').innerText = urssaf.toFixed(2) + ' ‚Ç¨';
            document.getElementById('net-frais').innerText = frais.toFixed(2) + ' ‚Ç¨';
            document.getElementById('net-real-res').innerText = (ca - urssaf - frais).toFixed(2) + ' ‚Ç¨';
        }

        // --- COMPTA & D√âPENSES ---
        function addExpense() {
            const label = document.getElementById('exp-label').value;
            const val = parseFloat(document.getElementById('exp-val').value);
            if(!label || !val) return;
            DB.expenses.push({label, val, date: new Date().toLocaleDateString()});
            localStorage.setItem('mse_expenses', JSON.stringify(DB.expenses));
            renderExpenses();
            document.getElementById('exp-label').value = '';
            document.getElementById('exp-val').value = '';
        }

        function renderExpenses() {
            const list = document.getElementById('expense-list');
            list.innerHTML = DB.expenses.map(e => `<div class="expense-item"><b>${e.val}‚Ç¨</b> - ${e.label} <small>${e.date}</small></div>`).join('');
        }

        function updateCompta() {
            let rev = 0;
            DB.docs.filter(d => d.type === 'FACTURE').forEach(f => rev += parseFloat(f.totalHT));
            let exp = 0;
            DB.expenses.forEach(e => exp += e.val);
            document.getElementById('compta-inc').innerText = rev.toFixed(2) + '‚Ç¨';
            document.getElementById('compta-exp').innerText = exp.toFixed(2) + '‚Ç¨';
            document.getElementById('compta-net').innerText = (rev - exp).toFixed(2) + ' ‚Ç¨';
        }

        function updateYield() {
            let y = 0;
            const list = document.getElementById('validated-list');
            list.innerHTML = '';
            DB.docs.filter(d => d.type === 'DEVIS').forEach(d => {
                y += parseFloat(d.totalTTC);
                list.innerHTML += `<div class="income-item"><b>${d.totalTTC}‚Ç¨</b> - ${d.client}</div>`;
            });
            document.getElementById('yield-total').innerText = y.toFixed(2) + ' ‚Ç¨';
        }

        // --- PDF GENERATION ---
        function saveDoc(type) {
            const num = document.getElementById('doc-num').value || 'Brouillon';
            const client = document.getElementById('c-name').value || 'Client';
            const addr = document.getElementById('c-addr').value;
            let ht = 0;
            let rows = "";
            document.querySelectorAll('#lines-container .card').forEach(c => {
                const n = c.querySelector('.l-n').value;
                const q = c.querySelector('.l-q').value;
                const p = c.querySelector('.l-p').value;
                ht += (q*p);
                rows += `<tr><td>${n}</td><td>${q}</td><td>${p}‚Ç¨</td><td>${(q*p).toFixed(2)}‚Ç¨</td></tr>`;
            });

            const ttc = (ht * 1.2).toFixed(2);
            DB.docs.push({type, num, client, totalHT: ht, totalTTC: ttc, date: new Date().toLocaleDateString()});
            localStorage.setItem('mse_docs', JSON.stringify(DB.docs));

            document.getElementById('pdf-paper').innerHTML = `
                <div style="padding:40px;">
                    <div style="display:flex; justify-content:space-between; border-bottom:2px solid #000; padding-bottom:20px;">
                        <div><strong>${USER.name}</strong><br>${USER.addr}</div>
                        <div style="text-align:right"><strong>${type} N¬∞ ${num}</strong><br>Date: ${new Date().toLocaleDateString()}</div>
                    </div>
                    <div style="margin:20px 0;"><strong>CLIENT:</strong><br>${client}<br>${addr}</div>
                    <table style="width:100%; border-collapse:collapse;">
                        <tr style="background:#eee;"><th>DESC</th><th>QT√â</th><th>P.U</th><th>TOTAL</th></tr>
                        ${rows}
                    </table>
                    <div style="float:right; width:200px; margin-top:20px; font-weight:bold;">
                        Total HT: ${ht.toFixed(2)}‚Ç¨<br>
                        TVA (20%): ${(ht*0.2).toFixed(2)}‚Ç¨<br>
                        TOTAL TTC: ${ttc}‚Ç¨
                    </div>
                </div>`;
            document.getElementById('preview-overlay').style.display = 'flex';
        }

        function closePreview() { document.getElementById('preview-overlay').style.display = 'none'; }
        function downloadPDF() {
            html2pdf().set({ margin: 0, filename: 'MSE_Document.pdf', html2canvas: { scale: 3 } }).from(document.getElementById('pdf-paper')).save();
        }

        // Initialize
        renderExpenses();
    </script>
</body>
</html>
