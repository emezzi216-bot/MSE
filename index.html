<!DOCTYPE html>
<html lang="fr" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>MSE ONE</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg: #000; --card: #141416; --border: rgba(255, 255, 255, 0.08);
            --mse-red: #D32F2F; --text: #FFFFFF; --text-dim: #929297; --radius: 24px;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'Inter', sans-serif; }
        body { margin: 0; background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; }

        header { padding: calc(env(safe-area-inset-top) + 20px) 24px 10px; display: flex; justify-content: space-between; align-items: center; }
        .brand { font-size: 28px; font-weight: 900; letter-spacing: -1.5px; }
        .brand span { color: var(--mse-red); }
        
        #hub { height: 100%; overflow-y: auto; padding: 0 16px 180px; }
        .apps-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        .section-label { grid-column: span 3; font-size: 11px; font-weight: 800; color: var(--text-dim); text-transform: uppercase; margin: 25px 0 10px 5px; }

        .app { display: flex; flex-direction: column; align-items: center; gap: 8px; cursor: pointer; }
        .app span { font-size: 10px; font-weight: 700; text-align: center; color: var(--text); }
        .icon-box { width: 95px; height: 95px; border-radius: 22px; overflow: hidden; background: var(--card); border: 1px solid var(--border); transition: transform 0.1s; }
        .icon-box img { width: 100%; height: 100%; object-fit: cover; }
        .app:active .icon-box { transform: scale(0.9); }

        .window { position: fixed; inset: 0; background: var(--bg); z-index: 1000; display: none; flex-direction: column; }
        .win-header { padding: calc(env(safe-area-inset-top) + 15px) 20px; display: flex; align-items: center; gap: 20px; border-bottom: 1px solid var(--border); }
        .back-btn { font-size: 32px; background: none; border: none; color: white; cursor: pointer; }
        .win-body { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 180px; }
        
        .pro-card { background: var(--card); border-radius: 28px; padding: 22px; margin-bottom: 16px; border: 1px solid var(--border); }
        .pro-card h4 { margin: 0 0 12px; font-size: 10px; color: var(--mse-red); text-transform: uppercase; font-weight: 800; }
        input, textarea, select { width: 100%; background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: 16px; padding: 15px; color: var(--text); font-size: 15px; margin-bottom: 10px; outline: none; }
        .readonly { background: rgba(255,255,255,0.01) !important; color: var(--text-dim) !important; border-style: dashed !important; }

        .dock { position: fixed; bottom: 30px; left: 20px; right: 20px; background: rgba(20, 20, 20, 0.95); backdrop-filter: blur(40px); border: 1px solid var(--border); border-radius: 40px; padding: 18px 28px; display: flex; justify-content: space-between; align-items: center; z-index: 1100; }
        .btn-mse { background: var(--mse-red); color: #fff; border: none; padding: 18px 35px; border-radius: 22px; font-weight: 900; font-size: 14px; cursor: pointer; }

        #pdf-paper { width: 210mm; background: white !important; color: black !important; display: none; font-family: 'Roboto', sans-serif; }
    </style>
</head>
<body>

<header><div class="brand">MSE <span>ONE</span></div></header>

<div id="hub">
    <div class="apps-grid">
        <div class="section-label">Facturation Premium</div>
        <div class="app" onclick="openApp('FACTURE', 'premium')"><div class="icon-box"><img src="facture.png"></div><span>Facture TVA</span></div>
        <div class="app" onclick="openApp('DEVIS', 'premium')"><div class="icon-box"><img src="devis.png"></div><span>Devis TVA</span></div>
        <div class="app" onclick="openApp('ACQUITTEE')"><div class="icon-box"><img src="acquittee.png"></div><span>Tampon PDF</span></div>

        <div class="section-label">R√©gime Micro</div>
        <div class="app" onclick="openApp('FACTURE', 'micro')"><div class="icon-box"><img src="facture.png"></div><span>Facture Net</span></div>
        <div class="app" onclick="openApp('DEVIS', 'micro')"><div class="icon-box"><img src="devis.png"></div><span>Devis Net</span></div>

        <div class="section-label">Gestion & Finance</div>
        <div class="app" onclick="openApp('CLIENTS')"><div class="icon-box"><img src="clients.png"></div><span>Clients</span></div>
        <div class="app" onclick="openApp('PREVISIONNEL')"><div class="icon-box"><img src="rendement.png"></div><span>Mois par Mois</span></div>
        <div class="app" onclick="openApp('URSSAF')"><div class="icon-box"><img src="urssaf.png"></div><span>URSSAF</span></div>
        <div class="app" onclick="openApp('ARCHIVES')"><div class="icon-box"><img src="archives.png"></div><span>Historique</span></div>
    </div>
</div>

<div id="win" class="window">
    <div class="win-header"><button class="back-btn" onclick="goBack()">‚Üê</button><b id="win-title"></b></div>
    <div class="win-body" id="win-content"></div>
    <div class="dock" id="win-dock" style="display:none;">
        <div id="dock-total" style="font-size:22px; font-weight:900;">0.00 ‚Ç¨</div>
        <button class="btn-mse" id="main-btn" onclick="generatePreview()">G√âN√âRER PDF</button>
    </div>
</div>

<div id="pdf-paper"></div>

<script>
/* --- CONFIG & DB --- */
const USER = { 
    name: "Sabri BENNACEUR EI", siren: "943032755", 
    addr: "2 R√©sidence des Rosiers, Puteaux, FR", email: "serruremse@gmail.com",
    dec: "RC d√©cennale TETRIS police n¬∞ SV75018041T37384",
    iban: "FR76 1695 8000 0159 6810 0824 765", bic: "ONTO FR P1 XXX" 
};
let db = { 
    clients: JSON.parse(localStorage.getItem('mse_clients') || '[]'), 
    history: JSON.parse(localStorage.getItem('mse_history') || '[]') 
};
let curType, curMode;

window.addEventListener('popstate', () => { document.getElementById('win').style.display = 'none'; });
function goBack() { window.history.back(); }

function openApp(type, mode='premium'){
    curType = type; curMode = mode;
    history.pushState({view: 'app'}, ''); 
    document.getElementById('win').style.display = 'flex';
    document.getElementById('win-title').innerText = type;
    const cont = document.getElementById('win-content');
    const dock = document.getElementById('win-dock');
    dock.style.display = (['DEVIS','FACTURE'].includes(type)) ? 'flex' : 'none';

    if(['DEVIS','FACTURE'].includes(type)) renderEditor(cont);
    else if(type === 'CLIENTS') renderClients(cont);
    else if(type === 'PREVISIONNEL') renderForecast(cont);
    else if(type === 'URSSAF') renderUrssaf(cont);
    else if(type === 'ARCHIVES') renderHistory(cont);
    else if(type === 'ACQUITTEE') renderAcquit(cont);
}

/* --- MODULES GESTION --- */
function renderClients(c) {
    c.innerHTML = `<div class="pro-card"><h4>Nouveau Client</h4><input id="cn" placeholder="Nom"><textarea id="ca" placeholder="Adresse" rows="2"></textarea><button class="btn-mse" style="width:100%" onclick="saveClient()">AJOUTER</button></div>
    <div class="pro-card"><h4>R√©pertoire</h4>${db.clients.map((cli,i)=>`<div style="display:flex;justify-content:space-between;padding:12px 0;border-bottom:1px solid var(--border)"><b>${cli.name}</b><span onclick="delCli(${i})" style="color:red">‚úï</span></div>`).join('')}</div>`;
}
function saveClient(){ const n=document.getElementById('cn').value; if(n){db.clients.push({name:n, addr:document.getElementById('ca').value}); sync(); renderClients(document.getElementById('win-content'));}}
function delCli(i){ db.clients.splice(i,1); sync(); renderClients(document.getElementById('win-content'));}

function renderForecast(c) {
    let monthly = {};
    db.history.forEach(h => {
        const month = h.date.split('/')[1] + '/' + h.date.split('/')[2];
        monthly[month] = (monthly[month] || 0) + h.val;
    });
    let html = `<div class="pro-card" style="text-align:center"><h4>Pr√©visionnel CA Global</h4><h1 style="font-size:40px">${Object.values(monthly).reduce((a,b)=>a+b,0).toFixed(2)} ‚Ç¨</h1></div>`;
    Object.keys(monthly).sort().reverse().forEach(m => {
        html += `<div class="pro-card"><h4>Mois : ${m}</h4><div style="display:flex;justify-content:space-between;font-size:20px;font-weight:900;"><span>Total NET</span><span>${monthly[m].toFixed(2)} ‚Ç¨</span></div></div>`;
    });
    c.innerHTML = html;
}

function renderUrssaf(c) {
    c.innerHTML = `<div class="pro-card"><h4>Calculateur URSSAF</h4><p style="font-size:12px; color:var(--text-dim);">Taux de cotisation Micro-Entrepreneur : 21,2%</p>
    <input type="number" id="ca-ht" placeholder="Entrez le CA HT total" oninput="document.getElementById('tax-res').innerText = (this.value * 0.212).toFixed(2) + ' ‚Ç¨'">
    <div style="display:flex; justify-content:space-between; margin-top:20px; font-size:20px; font-weight:900;"><span>√Ä payer :</span><span id="tax-res" style="color:var(--mse-red);">0.00 ‚Ç¨</span></div></div>`;
}

function renderHistory(c){ c.innerHTML=`<div class="pro-card"><h4>Archives</h4>${db.history.reverse().map(h=>`<div style="padding:12px 0;border-bottom:1px solid var(--border);"><b>${h.num}</b> - ${h.client}<br><small>${h.date} | ${h.val.toFixed(2)}‚Ç¨</small></div>`).join('')}</div>`;}

function renderAcquit(c) {
    c.innerHTML = `<div class="pro-card"><h4>Import PDF</h4><input type="file" id="pdf-up" accept="application/pdf" style="padding:30px; border:2px dashed var(--border);"><button class="btn-mse" style="width:100%; margin-top:15px;" onclick="processPdf()">ACQUITTER LE PDF</button></div>`;
}
async function processPdf() {
    const f=document.getElementById('pdf-up').files[0]; if(!f) return;
    const r=new FileReader(); r.onload=async function(){
        const doc=await PDFLib.PDFDocument.load(new Uint8Array(this.result));
        const page=doc.getPages()[0]; const {width, height}=page.getSize();
        page.drawText('ACQUITT√âE', {x:width-200, y:height-100, size:32, color:PDFLib.rgb(0.8,0.2,0.2), rotate:PDFLib.degrees(-15)});
        const out=await doc.save(); const l=document.createElement("a"); l.href=URL.createObjectURL(new Blob([out],{type:"application/pdf"})); l.download=`ACQUITTEE_${Date.now()}.pdf`; l.click();
    }; r.readAsArrayBuffer(f);
}

function renderEditor(c) {
    const today = new Date().toISOString().split('T')[0];
    c.innerHTML = `
        <div class="pro-card"><h4>üìÅ Dates & Admin</h4>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                <div><label style="font-size:10px;">√âMISSION</label><input type="date" id="d-e" value="${today}"></div>
                <div><label style="font-size:10px;">√âCH√âANCE / VALIDIT√â</label><input type="date" id="d-h" value="${today}"></div>
            </div>
            <input class="readonly" value="SIRET : ${USER.siren}" readonly>
            <input class="readonly" value="${USER.dec}" readonly>
        </div>
        <div class="pro-card"><h4>üë§ Client & Objet</h4>
            <select onchange="fillCli(this.value)"><option value="">Clients...</option>${db.clients.map((cli,i)=>`<option value="${i}">${cli.name}</option>`).join('')}</select>
            <input id="cn" placeholder="NOM DU CLIENT"><textarea id="ca" placeholder="ADRESSE DU CLIENT" rows="2"></textarea>
            <input id="ref" placeholder="R√©f√©rence dossier">
            <input id="dn" placeholder="NUM√âRO">
            <input id="do" placeholder="Objet de l'intervention">
        </div>
        ${curMode==='premium'?`<div class="pro-card"><h4>‚öôÔ∏è TVA</h4><select id="tva" onchange="calc()"><option value="20">20%</option><option value="10">10%</option><option value="5.5">5.5%</option></select></div>`:''}
        <div class="pro-card"><h4>üõ†Ô∏è Lignes</h4><div id="lines"></div><button onclick="addLine()" style="width:100%;background:none;border:1px dashed #fff;padding:15px;border-radius:15px;">+ AJOUTER LIGNE</button></div>`;
    addLine();
}
function fillCli(i){ if(i==="")return; document.getElementById('cn').value=db.clients[i].name; document.getElementById('ca').value=db.clients[i].addr; }
function addLine(){
    const d=document.createElement('div'); d.className="line-item"; d.style.borderBottom="1px solid var(--border)"; d.style.paddingBottom="10px"; d.style.marginBottom="10px";
    d.innerHTML=`<input class="lt" placeholder="Prestation" style="font-weight:900;"><textarea class="ld" placeholder="D√©tails" rows="1" style="font-style:italic;font-weight:300;border:none;"></textarea>
    <div style="display:flex;gap:10px;"><input type="number" class="lq" value="1" style="flex:1" oninput="calc()"><input type="number" class="lp" placeholder="P.U. HT" style="flex:2" oninput="calc()"></div>`;
    document.getElementById('lines').appendChild(d);
}
function calc() {
    let tHT=0; document.querySelectorAll('.lq').forEach((q,i)=>{ tHT+=(q.value*document.querySelectorAll('.lp')[i].value); });
    const rate = curMode === 'premium' ? parseFloat(document.getElementById('tva').value) : 0;
    const final = tHT * (1 + rate/100);
    document.getElementById('dock-total').innerText = final.toFixed(2) + " ‚Ç¨"; return {tHT, final, rate};
}

function generatePreview() {
    const data=calc(); const docNum=document.getElementById('dn').value || "SANS-NUM";
    const refCli=document.getElementById('ref').value;
    const isQuote=(curType==='DEVIS');
    const dEmit=new Date(document.getElementById('d-e').value).toLocaleDateString('fr-FR');
    const dDue=new Date(document.getElementById('d-h').value).toLocaleDateString('fr-FR');
    
    db.history.push({num:docNum, client:document.getElementById('cn').value, val:data.tHT, date: dEmit}); sync();

    let rows = ""; document.querySelectorAll('.lt').forEach((t,i)=>{
        const q=document.querySelectorAll('.lq')[i].value; const p=document.querySelectorAll('.lp')[i].value;
        const mtTVA = (q*p*(data.rate/100)).toFixed(2);
        rows += `<tr>
            <td style="padding:10px; border-bottom:1px solid #eee;">
                <strong>${t.value}</strong><br><span style="font-size:11px; color:#555;">${document.querySelectorAll('.ld')[i].value}</span>
            </td>
            <td style="text-align:center">${q}</td>
            <td style="text-align:right">${parseFloat(p).toFixed(2)} ‚Ç¨</td>
            <td style="text-align:right">${(q*p).toFixed(2)} ‚Ç¨</td>
            ${curMode==='premium'?`<td style="text-align:center">${data.rate}%</td><td style="text-align:right">${mtTVA} ‚Ç¨</td>`:''}
        </tr>`;
    });

    document.getElementById('pdf-paper').innerHTML = `
    <div style="padding:40px; background:white; color:#333; width:100%; box-sizing:border-box;">
        <div style="display:flex; justify-content:space-between; border-bottom:2px solid #eee; padding-bottom:40px;">
            <div style="width:55%;">
                <div style="margin-bottom:20px;"><img src="logo.png" style="max-width:280px; max-height:150px;" onerror="this.style.display='none'"></div>
                <div style="font-size:13px; color:#555; line-height:1.5;">
                    <strong>${USER.name}</strong><br>${USER.addr}<br>Email : ${USER.email}<br>
                    SIRET : ${USER.siren}<br>Assurance : ${USER.dec}
                </div>
            </div>
            <div style="background:#f8f8f8; color:#000; padding:20px; width:35%; border-radius:4px; border-left:4px solid #333;">
                <strong style="color:#D32F2F; font-size:10px; text-transform:uppercase;">${isQuote?'Devis pour :':'Facturer √† :'}</strong><br><br>
                <strong style="font-size:16px;">${document.getElementById('cn').value}</strong><br>
                ${document.getElementById('ca').value.replace(/\n/g,'<br>')}
            </div>
        </div>
        <div style="padding:40px 0;">
            <div style="display:flex; justify-content:space-between; align-items:flex-end; border-bottom:3px solid #D32F2F; padding-bottom:15px; margin-bottom:30px;">
                <div>
                    <h1 style="margin:0; font-size:32px; color:#333;">${curType} N¬∞ ${docNum}</h1>
                    <div style="color:#D32F2F; font-weight:bold; margin-top:5px;">Objet : ${document.getElementById('do').value}</div>
                    ${refCli ? `<div style="font-size:13px; margin-top:5px;">R√©f : ${refCli}</div>` : ''}
                </div>
                <div style="text-align:right; font-size:13px; color:#555;">
                    <strong>Date d'√©mission :</strong> ${dEmit}<br>
                    <strong>${isQuote?'Validit√© jusqu\'au':'Date d\'√©ch√©ance'} :</strong> ${dDue}
                </div>
            </div>
            <table style="width:100%; border-collapse:collapse; font-size:13px;">
                <thead><tr style="background:#333; color:#fff; text-transform:uppercase;">
                    <th style="padding:10px; text-align:left;">D√©signation</th>
                    <th style="text-align:center;">Qt√©</th><th style="text-align:right;">P.U HT</th><th style="text-align:right;">Total HT</th>
                    ${curMode==='premium'?'<th style="text-align:center;">TVA</th><th style="text-align:right;">Mt TVA</th>':''}
                </tr></thead>
                <tbody>${rows}</tbody>
            </table>
            <div style="display:flex; justify-content:flex-end; margin-top:30px;">
                <table style="width:300px; text-align:right;">
                    <tr><td>Total HT</td><td>${data.tHT.toFixed(2)} ‚Ç¨</td></tr>
                    ${curMode==='premium'?`<tr><td>Total TVA (${data.rate}%)</td><td>${(data.final-data.tHT).toFixed(2)} ‚Ç¨</td></tr>`:''}
                    <tr style="font-size:18px; font-weight:bold; color:#D32F2F; border-top:2px solid #000; padding-top:10px;">
                        <td>${curMode==='premium'?'NET √Ä PAYER TTC':'MONTANT NET'}</td><td>${data.final.toFixed(2)} ‚Ç¨</td>
                    </tr>
                </table>
            </div>
            <div style="margin-top:50px; border-top:1px solid #ddd; padding-top:20px; display:flex; justify-content:space-between; font-size:12px; color:#555;">
                <div style="width:55%;">
                    <strong>Conditions de r√®glement :</strong><br>
                    ${isQuote?'Facture √† r√©gler √† r√©ception.':'Paiement imm√©diat.'}<br>
                    Retard : P√©nalit√©s l√©gales + 40‚Ç¨. Pas d'escompte.<br>
                    <div style="background:#f9f9f9; padding:10px; border-left:3px solid #D32F2F; font-family:monospace; margin-top:10px;">
                        IBAN : ${USER.iban}<br>BIC : ${USER.bic}
                    </div>
                </div>
                <div style="width:40%; text-align:right;">
                    <br><br>${isQuote?'<div style="border:1px solid #ccc; padding:10px; height:80px;">Bon pour accord,<br>Date et Signature :</div>':'<strong>Signature et cachet</strong>'}
                </div>
            </div>
            <div style="margin-top:40px; text-align:center; font-size:11px; font-style:italic; color:#555;">
                ${curMode==='micro'?'TVA non applicable, art. 293 B du CGI. | ':''}Cette facture concerne uniquement de la prestation de service.
            </div>
        </div>
    </div>`;

    document.getElementById('pdf-paper').style.display = 'block';
    html2pdf().set({ margin:0, filename:`${curType}_${docNum}.pdf`, html2canvas:{scale:3, useCORS:true}, jsPDF:{unit:'mm', format:'a4'} })
    .from(document.getElementById('pdf-paper')).save().then(() => {
        document.getElementById('pdf-paper').style.display = 'none';
        goBack();
    });
}
function sync(){ localStorage.setItem('mse_clients', JSON.stringify(db.clients)); localStorage.setItem('mse_history', JSON.stringify(db.history)); }
</script>
</body>
</html>
