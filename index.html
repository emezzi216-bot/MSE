<!DOCTYPE html>
<html lang="fr" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>MSE TOOL Elite</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg: #000000; --card: rgba(20, 20, 22, 0.95); --border: rgba(255, 255, 255, 0.1);
            --mse-red: #D32F2F; --text: #FFFFFF; --text-dim: #929297; --radius: 24px;
        }
        [data-theme="light"] {
            --bg: #F2F2F7; --card: rgba(255, 255, 255, 0.95); --border: rgba(0, 0, 0, 0.1);
            --text: #000000; --text-dim: #666666;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'Inter', sans-serif; transition: 0.2s; }
        body { margin: 0; background-color: var(--bg); color: var(--text); height: 100vh; overflow: hidden; position: relative; }

        body::before {
            content: ""; position: fixed; inset: 0; z-index: -1;
            background: url('logo.png') no-repeat center center; background-size: cover;
            filter: blur(30px) grayscale(20%); opacity: 0.25; pointer-events: none;
        }

        header { padding: calc(env(safe-area-inset-top) + 20px) 24px 10px; display: flex; justify-content: space-between; align-items: center; position: relative; z-index: 2; }
        .brand { font-size: 28px; font-weight: 900; letter-spacing: -1.5px; }
        .brand span { color: var(--mse-red); }
        .theme-toggle { width: 44px; height: 44px; border-radius: 12px; background: var(--card); border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; font-size: 20px; cursor: pointer; backdrop-filter: blur(10px); }

        #hub { height: 100%; overflow-y: auto; padding: 0 16px 180px; position: relative; z-index: 1; }
        .apps-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        .section-label { grid-column: span 3; font-size: 11px; font-weight: 800; color: var(--text-dim); text-transform: uppercase; margin: 25px 0 10px 5px; }

        .app { display: flex; flex-direction: column; align-items: center; gap: 8px; cursor: pointer; }
        .app span { font-size: 10px; font-weight: 700; text-align: center; color: var(--text); }
        .icon-box { width: 95px; height: 95px; border-radius: 22px; overflow: hidden; background: var(--card); border: 1px solid var(--border); box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .icon-box img { width: 100%; height: 100%; object-fit: cover; }

        .window { position: fixed; inset: 0; background: var(--bg); z-index: 1000; display: none; flex-direction: column; }
        .window[style*="display: flex"] { background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(15px); }

        .win-header { padding: calc(env(safe-area-inset-top) + 15px) 20px; display: flex; align-items: center; gap: 20px; border-bottom: 1px solid var(--border); background: var(--card); }
        .back-btn { font-size: 32px; background: none; border: none; color: var(--text); cursor: pointer; }
        .win-body { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 180px; }
        
        .pro-card { background: var(--card); border-radius: 28px; padding: 22px; margin-bottom: 16px; border: 1px solid var(--border); backdrop-filter: blur(10px); }
        .pro-card h4 { margin: 0 0 12px; font-size: 10px; color: var(--mse-red); text-transform: uppercase; font-weight: 800; }
        input, textarea, select { width: 100%; background: rgba(128,128,128,0.05); border: 1px solid var(--border); border-radius: 16px; padding: 15px; color: var(--text); font-size: 15px; margin-bottom: 10px; outline: none; }
        .readonly { background: rgba(128,128,128,0.02) !important; color: var(--text-dim) !important; border-style: dashed !important; }

        .dock { position: fixed; bottom: 30px; left: 20px; right: 20px; background: var(--card); border: 1px solid var(--border); border-radius: 40px; padding: 18px 28px; display: flex; justify-content: space-between; align-items: center; z-index: 1100; backdrop-filter: blur(20px); }
        .btn-mse { background: var(--mse-red); color: #fff; border: none; padding: 18px 35px; border-radius: 22px; font-weight: 900; cursor: pointer; }

        #pdf-paper { width: 210mm; background: white !important; color: black !important; display: none; font-family: 'Roboto', sans-serif; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 2000; display: none; justify-content: center; align-items: center; padding: 20px; backdrop-filter: blur(15px); }
        .modal-content { background: var(--card); padding: 25px; border-radius: 28px; width: 100%; max-width: 450px; border: 1px solid var(--border); max-height: 80vh; overflow-y: auto; }
        .archive-line { font-size: 11px; padding: 8px 0; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; }
        .list-item-clickable { display: flex; justify-content: space-between; padding: 15px 0; border-bottom: 1px solid var(--border); cursor: pointer; }
        
        /* COLOR PICKER STYLES */
        .color-row { display: flex; align-items: center; gap: 15px; margin-bottom: 10px; }
        .color-row label { flex: 1; font-size: 13px; }
        .color-row input[type="color"] { width: 50px; height: 35px; padding: 0; border: none; border-radius: 8px; cursor: pointer; }
    </style>
</head>
<body>

<header>
    <div class="brand">MSE <span>TOOL</span></div>
    <div class="theme-toggle" onclick="toggleTheme()">üåì</div>
</header>

<div id="hub">
    <div class="apps-grid">
        <div class="section-label" id="label-premium">Facturation Elite</div>
        <div class="app" onclick="openApp('FACTURE', 'premium')"><div class="icon-box"><img src="facture.png"></div><span class="txt-facture">Facture TVA</span></div>
        <div class="app" onclick="openApp('DEVIS', 'premium')"><div class="icon-box"><img src="devis.png"></div><span class="txt-devis">Devis TVA</span></div>
        <div class="app" onclick="openApp('ACQUITTEE')"><div class="icon-box"><img src="acquittee.png"></div><span class="txt-tampon">Tampon PDF</span></div>

        <div class="section-label" id="label-micro">R√©gime Micro (TTC)</div>
        <div class="app" onclick="openApp('FACTURE', 'micro')"><div class="icon-box"><img src="facture.png"></div><span class="txt-facture">Facture TTC</span></div>
        <div class="app" onclick="openApp('DEVIS', 'micro')"><div class="icon-box"><img src="devis.png"></div><span class="txt-devis">Devis TTC</span></div>

        <div class="section-label" id="label-data">Base Clients & Archives</div>
        <div class="app" onclick="openApp('CLIENTS')"><div class="icon-box"><img src="clients.png"></div><span id="txt-clients">R√©pertoire</span></div>
        <div class="app" onclick="openApp('ARCHIVES')"><div class="icon-box"><img src="archives.png"></div><span id="txt-archives">Historique</span></div>
        <div class="app" onclick="openApp('SETTINGS')"><div class="icon-box"><img src="settings.png"></div><span id="txt-settings">Param√®tres</span></div>
    </div>
</div>

<div id="win" class="window">
    <div class="win-header"><button class="back-btn" onclick="goBack()">‚Üê</button><b id="win-title"></b></div>
    <div class="win-body" id="win-content"></div>
    <div class="dock" id="win-dock" style="display:none;">
        <div id="dock-total" style="font-size:22px; font-weight:900;">0.00 ‚Ç¨</div>
        <button class="btn-mse" id="main-btn" onclick="generatePreview()">G√âN√âRER PDF</button>
    </div>
</div>

<div id="archive-modal" class="modal-overlay" onclick="closeModal(event)">
    <div class="modal-content">
        <h2 id="modal-title" style="margin-top:0; color:var(--mse-red); font-size:20px;"></h2>
        <div id="modal-details" style="margin-bottom:20px;"></div>
        <div id="modal-lines" style="margin-bottom:20px;"></div>
        <button class="btn-mse" style="width:100%; margin-bottom:10px;" id="modal-download">RE-T√âL√âCHARGER</button>
        <button class="btn-mse" style="width:100%; background:none; border:1px solid var(--border);" onclick="closeModal(event)">FERMER</button>
    </div>
</div>

<div id="pdf-paper"></div>

<script>
/* --- DICTIONARY --- */
const TRANSLATIONS = {
    fr: {
        facture: "Facture", devis: "Devis", tampon: "Tampon PDF", clients: "R√©pertoire", archives: "Historique", settings: "Param√®tres",
        label_premium: "Facturation Elite (TVA)", label_micro: "R√©gime Micro (TTC)", label_data: "Donn√©es & R√©glages",
        col_main: "Couleur Principale", col_bg: "Fond d'√©cran", col_card: "Couleur des Cartes", reset: "R√©initialiser les couleurs"
    },
    en: {
        facture: "Invoice", devis: "Quote", tampon: "PDF Stamp", clients: "Contacts", archives: "History", settings: "Settings",
        col_main: "Main Color", col_bg: "Background Color", col_card: "Card Color", reset: "Reset Colors"
    }
};

/* --- DATA & CONFIG --- */
const USER = { 
    name: "Sabri BENNACEUR EI", siren: "943032755", addr: "2 R√©sidence des Rosiers, 92800 Puteaux, FR",
    email: "serruremse@gmail.com", dec: "RC d√©cennale TETRIS police n¬∞ SV75018041T37384",
    iban: "FR76 1695 8000 0159 6810 0824 765", bic: "ONTO FR P1 XXX" 
};
let db = { clients: JSON.parse(localStorage.getItem('mse_clients') || '[]'), history: JSON.parse(localStorage.getItem('mse_history') || '[]') };
let curLang = localStorage.getItem('mse_lang') || 'fr';
let curColors = JSON.parse(localStorage.getItem('mse_colors')) || { red: "#D32F2F", bg: "#000000", card: "#141416" };
let curType, curMode;

function t(key) { return (TRANSLATIONS[curLang] && TRANSLATIONS[curLang][key]) ? TRANSLATIONS[curLang][key] : (TRANSLATIONS['fr'][key] || key); }

function applyColors() {
    const root = document.documentElement;
    root.style.setProperty('--mse-red', curColors.red);
    root.style.setProperty('--bg', curColors.bg);
    root.style.setProperty('--card', curColors.card.includes('rgba') ? curColors.card : `rgba(${hexToRgb(curColors.card)}, 0.95)`);
}

function hexToRgb(hex) {
    const bigint = parseInt(hex.slice(1), 16);
    return [(bigint >> 16) & 255, (bigint >> 8) & 255, bigint & 255].join(',');
}

/* --- UI UPDATE --- */
function updateUI() {
    document.getElementById('label-premium').innerText = t('label_premium');
    document.getElementById('label-micro').innerText = t('label_micro');
    document.getElementById('label-data').innerText = t('label_data');
    document.getElementById('txt-clients').innerText = t('clients');
    document.getElementById('txt-archives').innerText = t('archives');
    document.getElementById('txt-settings').innerText = t('settings');
}

function toggleTheme() {
    const root = document.documentElement;
    const target = root.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
    root.setAttribute('data-theme', target);
    localStorage.setItem('mse_theme', target);
}
if(localStorage.getItem('mse_theme')) document.documentElement.setAttribute('data-theme', localStorage.getItem('mse_theme'));

window.addEventListener('popstate', () => { document.getElementById('win').style.display = 'none'; });
function goBack() { window.history.back(); }

function openApp(type, mode='premium'){
    curType = type; curMode = mode;
    history.pushState({view: 'app'}, ''); 
    document.getElementById('win').style.display = 'flex';
    document.getElementById('win-title').innerText = t(type.toLowerCase()) + " " + mode.toUpperCase();
    const cont = document.getElementById('win-content');
    const dock = document.getElementById('win-dock');
    dock.style.display = (['DEVIS','FACTURE'].includes(type)) ? 'flex' : 'none';

    if(['DEVIS','FACTURE'].includes(type)) renderEditor(cont);
    else if(type === 'CLIENTS') renderClients(cont);
    else if(type === 'ARCHIVES') renderHistory(cont);
    else if(type === 'ACQUITTEE') renderAcquit(cont);
    else if(type === 'SETTINGS') renderSettings(cont);
}

/* --- SETTINGS MODULE (COLOR PICKERS) --- */
function renderSettings(c) {
    c.innerHTML = `
        <div class="pro-card"><h4>Configuration Langue</h4>
            <select onchange="changeLang(this.value)">
                <option value="fr" ${curLang==='fr'?'selected':''}>Fran√ßais</option>
                <option value="en" ${curLang==='en'?'selected':''}>English</option>
            </select>
        </div>
        <div class="pro-card"><h4>Personnalisation Couleurs</h4>
            <div class="color-row"><label>${t('col_main')}</label><input type="color" value="${curColors.red}" onchange="updateColor('red', this.value)"></div>
            <div class="color-row"><label>${t('col_bg')}</label><input type="color" value="${curColors.bg}" onchange="updateColor('bg', this.value)"></div>
            <div class="color-row"><label>${t('col_card')}</label><input type="color" value="${curColors.card}" onchange="updateColor('card', this.value)"></div>
            <button class="btn-mse" style="width:100%; background:none; border:1px dashed var(--mse-red); font-size:11px; margin-top:15px;" onclick="resetColors()">${t('reset')}</button>
        </div>
        <div class="pro-card"><h4>System</h4><p style="font-size:11px;color:var(--text-dim);">MSE TOOL v37.0 Elite<br>Branding: Global Immersive<br>PDF Quality: 300 DPI Scale 3</p></div>`;
}

function updateColor(key, val) {
    curColors[key] = val;
    localStorage.setItem('mse_colors', JSON.stringify(curColors));
    applyColors();
}

function resetColors() {
    curColors = { red: "#D32F2F", bg: "#000000", card: "#141416" };
    localStorage.removeItem('mse_colors');
    applyColors();
    renderSettings(document.getElementById('win-content'));
}

function changeLang(val) { curLang = val; localStorage.setItem('mse_lang', val); updateUI(); goBack(); }

/* --- CORE FUNCTIONS (PDF & DATA) --- */
async function processPdf() {
    const f=document.getElementById('pdf-up').files[0]; if(!f) return;
    const r=new FileReader(); r.onload=async function(){
        const doc=await PDFLib.PDFDocument.load(new Uint8Array(this.result));
        const page=doc.getPages()[0]; const {width, height}=page.getSize();
        page.drawText("ACQUITT√âE", { x: width - 180, y: height - 60, size: 24, color: PDFLib.rgb(0.8, 0.1, 0.1), font: await doc.embedFont(PDFLib.StandardFonts.HelveticaBold) });
        const out=await doc.save(); const l=document.createElement("a"); l.href=URL.createObjectURL(new Blob([out],{type:"application/pdf"})); l.download=`ACQUITTEE.pdf`; l.click();
    }; r.readAsArrayBuffer(f);
}

function renderHistory(c) {
    const rev = [...db.history].reverse();
    c.innerHTML = `<div class="pro-card"><h4>Archives MSE TOOL</h4>
    ${rev.map((h, i) => `
        <div class="list-item-clickable" onclick="openArchiveDetail(${db.history.length - 1 - i})">
            <div><b>${h.num}</b><br><small>${h.client}</small></div>
            <div style="text-align:right;"><b>${h.final.toFixed(2)}‚Ç¨</b><br><small>${h.date}</small></div>
        </div>`).join('')}</div>`;
}

function openArchiveDetail(idx) {
    const h = db.history[idx];
    document.getElementById('modal-title').innerText = `${h.type} N¬∞ ${h.num}`;
    document.getElementById('modal-details').innerHTML = `<p style="font-size:13px;">${h.client}<br>${h.date}<br>Objet : ${h.obj}</p>`;
    document.getElementById('modal-lines').innerHTML = h.lines.map(l => `<div class="archive-line"><span>${l.lt}</span><b>${(l.lq*l.lp).toFixed(2)}‚Ç¨</b></div>`).join('');
    document.getElementById('modal-download').onclick = () => { rebuildPDF(h); };
    document.getElementById('archive-modal').style.display = 'flex';
}

function closeModal(e) { if (e.target.id === 'archive-modal' || e.target.tagName === 'BUTTON') document.getElementById('archive-modal').style.display = 'none'; }

function rebuildPDF(h) {
    curType = h.type; curMode = h.mode;
    renderPDFContent(h.num, h.client, h.addr, h.obj, h.ref, h.date, h.dueDate, h.lines, h.rate, h.val, h.final, h.c_siret, h.c_tva, h.c_legal);
    savePDF(h.num);
}

function renderEditor(c) {
    const today = new Date().toISOString().split('T')[0];
    const filteredClients = db.clients.filter(cli => cli.type === curMode);
    c.innerHTML = `
        <div class="pro-card"><h4>Dates & Admin</h4>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                <div><label style="font-size:10px;">√âMISSION</label><input type="date" id="d-e" value="${today}"></div>
                <div><label style="font-size:10px;">√âCH√âANCE</label><input type="date" id="d-h" value="${today}"></div>
            </div>
            <input class="readonly" value="SIRET : ${USER.siren}" readonly><input class="readonly" value="${USER.dec}" readonly>
        </div>
        <div class="pro-card"><h4>Client & Dossier</h4>
            <select onchange="fillCli(this.value)"><option value="">Reconna√Ætre client...</option>${filteredClients.map(cli=>`<option value="${cli.name}">${cli.name}</option>`).join('')}</select>
            <input id="cn" placeholder="NOM CLIENT"><textarea id="ca" placeholder="ADRESSE" rows="2"></textarea>
            <div style="border-top:1px solid var(--border); margin-top:10px; padding-top:10px;">
                <input id="c-legal" placeholder="Forme juridique"><input id="c-siret" placeholder="SIRET Client"><input id="c-tva" placeholder="TVA Client">
            </div>
            <input id="ref" placeholder="R√©f. dossier"><input id="dn" placeholder="N¬∞ DOC"><input id="do" placeholder="OBJET">
        </div>
        ${curMode==='premium'?`<div class="pro-card"><h4>TVA</h4><select id="tva" onchange="calc()"><option value="20">20%</option><option value="10">10%</option><option value="5.5">5.5%</option></select></div>`:''}
        <div class="pro-card"><h4>Prestations</h4><div id="lines"></div><button onclick="addLine()" style="width:100%;background:none;border:1px dashed var(--mse-red);padding:15px;border-radius:15px;">+ LIGNE</button></div>`;
    addLine();
}

function fillCli(name){ 
    const cli = db.clients.find(c => c.name === name); 
    if(cli){ document.getElementById('cn').value=cli.name; document.getElementById('ca').value=cli.addr; document.getElementById('c-siret').value=cli.siret||""; document.getElementById('c-tva').value=cli.tva||""; document.getElementById('c-legal').value=cli.legal||""; }
}

function addLine(){
    const d=document.createElement('div'); d.className="line-item";
    d.innerHTML=`<input class="lt" placeholder="D√©signation" style="font-weight:900;"><textarea class="ld" placeholder="D√©tails" rows="1" style="font-style:italic;border:none;background:none;"></textarea>
    <div style="display:flex;gap:10px;"><input type="number" class="lq" value="1" oninput="calc()"><input type="number" class="lp" placeholder="Prix" oninput="calc()"></div>`;
    document.getElementById('lines').appendChild(d);
}

function calc() {
    let tHT=0; document.querySelectorAll('.lq').forEach((q,i)=>{ tHT+=(q.value*document.querySelectorAll('.lp')[i].value); });
    const rate = curMode === 'premium' ? parseFloat(document.getElementById('tva').value) : 0;
    const final = tHT * (1 + rate/100);
    document.getElementById('dock-total').innerText = final.toFixed(2) + " ‚Ç¨"; return {tHT, final, rate};
}

function generatePreview() {
    const data=calc(); const docNum=document.getElementById('dn').value || "SN";
    const clientName = document.getElementById('cn').value;
    const clientAddr = document.getElementById('ca').value;
    const dateE = new Date(document.getElementById('d-e').value).toLocaleDateString('fr-FR');
    const dateH = new Date(document.getElementById('d-h').value).toLocaleDateString('fr-FR');
    const lineData = Array.from(document.querySelectorAll('.line-item')).map(div => ({ lt: div.querySelector('.lt').value, ld: div.querySelector('.ld').value, lq: div.querySelector('.lq').value, lp: div.querySelector('.lp').value }));
    const cSiret = document.getElementById('c-siret').value; const cTva = document.getElementById('c-tva').value; const cLegal = document.getElementById('c-legal').value;

    db.history.push({ num: docNum, client: clientName, addr: clientAddr, obj: document.getElementById('do').value, ref: document.getElementById('ref').value, date: dateE, dueDate: dateH, val: data.tHT, final: data.final, rate: data.rate, mode: curMode, type: curType, lines: lineData, c_siret: cSiret, c_tva: cTva, c_legal: cLegal });
    const cliIdx = db.clients.findIndex(c => c.name === clientName);
    if(cliIdx === -1) db.clients.push({name: clientName, addr: clientAddr, type: curMode, siret: cSiret, tva: cTva, legal: cLegal}); else db.clients[cliIdx] = {name: clientName, addr: clientAddr, type: curMode, siret: cSiret, tva: cTva, legal: cLegal};
    sync(); renderPDFContent(docNum, clientName, clientAddr, document.getElementById('do').value, document.getElementById('ref').value, dateE, dateH, lineData, data.rate, data.tHT, data.final, cSiret, cTva, cLegal);
    savePDF(docNum);
}

function renderPDFContent(num, client, addr, obj, ref, dE, dH, lines, rate, tHT, final, siret, tva, legal) {
    const isPremium = (curMode === 'premium');
    let rows = lines.map(l => `<tr><td style="padding:12px; border-bottom:1px solid #eee;"><strong>${l.lt}</strong><br><small>${l.ld}</small></td>
    <td style="text-align:center">${l.lq}</td><td style="text-align:right">${parseFloat(l.lp).toFixed(2)} ‚Ç¨</td><td style="text-align:right">${(l.lq*l.lp).toFixed(2)} ‚Ç¨</td>
    ${isPremium?`<td style="text-align:center">${rate}%</td><td style="text-align:right">${(l.lq*l.lp*(rate/100)).toFixed(2)} ‚Ç¨</td>`:''}</tr>`).join('');

    document.getElementById('pdf-paper').innerHTML = `
    <div style="padding:40px; background:white; color:#333; width:100%; box-sizing:border-box;">
        <div style="display:flex; justify-content:space-between; border-bottom:2px solid #eee; padding-bottom:40px;">
            <div style="width:55%;"><img src="logo.png" style="max-width:280px; max-height:150px;">
            <div style="font-size:12px;"><strong>${USER.name}</strong><br>${USER.addr}<br>${USER.email}<br>SIRET: ${USER.siren}<br>${USER.dec}</div></div>
            <div style="background:#f8f8f8; color:#000; padding:20px; width:35%; border-left:4px solid #333;">
                <strong style="color:#D32F2F; font-size:10px;">FACTURER √Ä :</strong><br><br>
                <strong>${client}</strong><br>${legal?`<b>${legal}</b><br>`:''}${addr.replace(/\n/g,'<br>')}<br>${siret?`<span>${siret}</span><br>`:''}${tva?`<span>${tva}</span>`:''}
            </div>
        </div>
        <div style="padding:40px 0;">
            <div style="display:flex; justify-content:space-between; align-items:flex-end; border-bottom:3px solid #D32F2F; margin-bottom:30px;">
                <div><h1 style="margin:0; font-size:32px;">${curType} N¬∞ ${num}</h1><b>Objet : ${obj}</b></div>
                <div style="text-align:right; font-size:12px;"><strong>Date :</strong> ${dE}<br><strong>√âch√©ance :</strong> ${dH}</div>
            </div>
            <table style="width:100%; border-collapse:collapse; font-size:13px;"><thead><tr style="background:#333; color:#fff;"><th>D√©signation</th><th>Qt√©</th><th>${isPremium?'P.U HT':'P.U TTC'}</th><th>Total</th>${isPremium?'<th>TVA</th><th>Mt</th>':''}</tr></thead><tbody>${rows}</tbody></table>
            <div style="display:flex; justify-content:flex-end; margin-top:30px;"><table style="width:300px; text-align:right;">
                <tr style="font-size:18px; font-weight:bold; color:#D32F2F; border-top:2px solid #000;"><td>TOTAL TTC</td><td>${final.toFixed(2)} ‚Ç¨</td></tr>
            </table></div>
            <div style="margin-top:50px; border-top:1px solid #ddd; font-size:11px;">IBAN: ${USER.iban} | BIC: ${USER.bic}</div>
        </div>
    </div>`;
}

function savePDF(num) {
    document.getElementById('pdf-paper').style.display = 'block';
    html2pdf().set({ margin:0, filename:`${curType}_${num}.pdf`, html2canvas:{scale:3, useCORS:true}, jsPDF:{unit:'mm', format:'a4'} }).from(document.getElementById('pdf-paper')).save().then(() => {
        document.getElementById('pdf-paper').style.display = 'none';
        goBack();
    });
}
function sync(){ localStorage.setItem('mse_clients', JSON.stringify(db.clients)); localStorage.setItem('mse_history', JSON.stringify(db.history)); }
window.onload = () => { applyColors(); updateUI(); };
</script>
</body>
</html>
