<!DOCTYPE html>
<html lang="fr" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>MSE ONE | Full Logic Suite</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <style>
        :root {
            --bg: #000; --surface: #0A0A0A; --card: #1C1C1E; --border: rgba(255, 255, 255, 0.1);
            --mse-red: #D32F2F; --text: #FFFFFF; --text-dim: #929297; --radius-os: 26px;
        }
        [data-theme="light"] {
            --bg: #F2F2F7; --surface: #FFFFFF; --card: #FFFFFF; --border: rgba(0, 0, 0, 0.1); --text: #000; --text-dim: #86868B;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'Inter', sans-serif; transition: background 0.3s, transform 0.2s; }
        body { margin: 0; background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; }

        header { padding: calc(env(safe-area-inset-top) + 25px) 24px 15px; display: flex; justify-content: space-between; align-items: center; }
        .brand { font-size: 28px; font-weight: 900; letter-spacing: -1.5px; }
        .brand span { color: var(--mse-red); }

        #hub { height: 100%; overflow-y: auto; padding: 0 16px 180px; }
        .apps-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px 14px; }
        .section-label { grid-column: span 3; font-size: 11px; font-weight: 800; color: var(--text-dim); text-transform: uppercase; letter-spacing: 2px; margin: 30px 0 10px 5px; }

        .app { display: flex; flex-direction: column; align-items: center; gap: 10px; cursor: pointer; }
        .app span { font-size: 11px; font-weight: 600; text-align: center; color: var(--text); line-height: 1.2; }
        .icon-box { width: 85px; height: 85px; border-radius: 24px; overflow: hidden; background: var(--card); border: 1px solid var(--border); }
        .icon-box img { width: 100%; height: 100%; object-fit: cover; }
        .app:active .icon-box { transform: scale(0.9); }

        .window { position: fixed; inset: 0; background: var(--bg); z-index: 1000; display: none; flex-direction: column; animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .win-header { padding: calc(env(safe-area-inset-top) + 20px) 24px 15px; display: flex; align-items: center; gap: 20px; border-bottom: 1px solid var(--border); }
        .win-body { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 180px; }
        
        .pro-card { background: var(--card); border-radius: 28px; padding: 22px; margin-bottom: 16px; border: 1px solid var(--border); }
        .pro-card h4 { margin: 0 0 15px; font-size: 10px; color: var(--mse-red); text-transform: uppercase; letter-spacing: 2px; font-weight: 800; }
        
        input, textarea, select { width: 100%; background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: 18px; padding: 16px; color: var(--text); font-size: 16px; margin-bottom: 12px; outline: none; }
        
        .dock { position: fixed; bottom: 30px; left: 20px; right: 20px; background: rgba(20, 20, 20, 0.95); backdrop-filter: blur(40px); border: 1px solid var(--border); border-radius: 40px; padding: 20px 28px; display: flex; justify-content: space-between; align-items: center; z-index: 1100; }
        .btn-mse { background: var(--mse-red); color: #fff; border: none; padding: 18px 35px; border-radius: 22px; font-weight: 900; font-size: 14px; cursor: pointer; }

        #preview-overlay { display: none; position: fixed; inset: 0; background: #000; z-index: 2000; flex-direction: column; }
        #pdf-paper { background: white !important; color: black !important; width: 100%; min-height: 100%; }
        
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid var(--border); }
        .list-item:last-child { border: none; }
    </style>
</head>
<body>

<header><div class="brand">MSE <span>ONE</span></div></header>

<div id="hub">
    <div class="apps-grid">
        <div class="section-label">Facturation Elite</div>
        <div class="app" onclick="openApp('DEVIS', 'premium')"><div class="icon-box"><img src="devis.png"></div><span>Devis Premium</span></div>
        <div class="app" onclick="openApp('FACTURE', 'premium')"><div class="icon-box"><img src="facture.png"></div><span>Facture Premium</span></div>
        <div class="app" onclick="openApp('ACQUITTEE')"><div class="icon-box"><img src="acquittee.png"></div><span>Tampon PDF</span></div>

        <div class="section-label">R√©gime Micro</div>
        <div class="app" onclick="openApp('DEVIS', 'micro')"><div class="icon-box"><img src="devis.png"></div><span>Devis Micro</span></div>
        <div class="app" onclick="openApp('FACTURE', 'micro')"><div class="icon-box"><img src="facture.png"></div><span>Facture Micro</span></div>

        <div class="section-label">Gestion & Rapports</div>
        <div class="app" onclick="openApp('CLIENTS')"><div class="icon-box"><img src="clients.png"></div><span>Clients</span></div>
        <div class="app" onclick="openApp('RENDEMENT')"><div class="icon-box"><img src="rendement.png"></div><span>Rendement</span></div>
        <div class="app" onclick="openApp('URSSAF')"><div class="icon-box"><img src="urssaf.png"></div><span>URSSAF</span></div>
        <div class="app" onclick="openApp('ARCHIVES')"><div class="icon-box"><img src="archives.png"></div><span>Historique</span></div>
    </div>
</div>

<div id="win" class="window">
    <div class="win-header">
        <div onclick="closeApp()" style="font-size: 28px; cursor:pointer;">‚Üê</div>
        <b id="win-title" style="text-transform: uppercase; letter-spacing: 1px;"></b>
    </div>
    <div class="win-body" id="win-content"></div>
    <div class="dock" id="win-dock" style="display:none;">
        <div><div id="dock-label" style="font-size:10px; font-weight:900; color:var(--text-dim); text-transform:uppercase;">Montant</div><div id="dock-total" style="font-size:24px; font-weight:900;">0.00 ‚Ç¨</div></div>
        <button class="btn-mse" id="main-btn" onclick="generatePreview()">G√âN√âRER PDF</button>
    </div>
</div>

<div id="preview-overlay">
    <div style="padding: 60px 20px 20px; display:flex; gap:12px; background:rgba(0,0,0,0.9);">
        <button class="btn-mse" style="flex:1; background:#222;" onclick="document.getElementById('preview-overlay').style.display='none'">RETOUR</button>
        <button class="btn-mse" style="flex:2;" onclick="downloadPDF()">T√âL√âCHARGER UHD</button>
    </div>
    <div style="flex:1; overflow-y:auto; padding:15px; background:#111;"><div id="pdf-paper"></div></div>
</div>

<script>
/* --- DATABASE & CONFIG --- */
let db = {
    clients: JSON.parse(localStorage.getItem('mse_clients') || '[]'),
    history: JSON.parse(localStorage.getItem('mse_history') || '[]')
};
const USER = { 
    name: "Sabri BENNACEUR EI", addr: "2 R√©sidence des Rosiers, 92800 Puteaux, FR", email: "serruremse@gmail.com",
    siren: "943 032 755 00010", decennale: "RC d√©cennale TETRIS police n¬∞ SV75018041T37384",
    iban: "FR76 1695 8000 0159 6810 0824 765", bic: "ONTO FR P1 XXX" 
};

let curMode = "premium"; let curType = "FACTURE";

function openApp(type, mode='standard'){
    curType = type; curMode = mode;
    const win = document.getElementById('win');
    const content = document.getElementById('win-content');
    const dock = document.getElementById('win-dock');
    win.style.display = 'flex';
    document.getElementById('win-title').innerText = type;
    dock.style.display = 'none';

    if(['DEVIS','FACTURE'].includes(type)) { dock.style.display = 'flex'; renderEditor(content); }
    else if(type === 'CLIENTS') renderClients(content);
    else if(type === 'RENDEMENT') renderYield(content);
    else if(type === 'URSSAF') renderUrssaf(content);
    else if(type === 'ARCHIVES') renderHistory(content);
    else if(type === 'ACQUITTEE') renderAcquit(content);
}

function closeApp(){ document.getElementById('win').style.display = 'none'; }

/* --- 1. MODULE CLIENTS --- */
function renderClients(c) {
    c.innerHTML = `
        <div class="pro-card"><h4>Ajouter un client</h4>
        <input id="new-c-name" placeholder="Nom complet">
        <textarea id="new-c-addr" placeholder="Adresse compl√®te" rows="2"></textarea>
        <button class="btn-mse" style="width:100%" onclick="saveClient()">ENREGISTRER</button></div>
        <div class="pro-card"><h4>Base de donn√©es</h4><div id="c-list">${db.clients.map((cli, i) => `<div class="list-item"><div><b>${cli.name}</b></div><div style="color:red" onclick="deleteClient(${i})">Supprimer</div></div>`).join('')}</div></div>`;
}
function saveClient() {
    const n = document.getElementById('new-c-name').value;
    const a = document.getElementById('new-c-addr').value;
    if(n && a) { db.clients.push({name:n, addr:a}); localStorage.setItem('mse_clients', JSON.stringify(db.clients)); renderClients(document.getElementById('win-content')); }
}
function deleteClient(i) { db.clients.splice(i,1); localStorage.setItem('mse_clients', JSON.stringify(db.clients)); renderClients(document.getElementById('win-content')); }

/* --- 2. MODULE RENDEMENT --- */
function renderYield(c) {
    let totalHT = 0; db.history.forEach(doc => totalHT += doc.totalHT);
    c.innerHTML = `<div class="pro-card" style="text-align:center;"><h4>Chiffre d'Affaires Cumul√©</h4><h1 style="font-size:42px; margin:10px 0;">${totalHT.toFixed(2)} ‚Ç¨</h1><p style="color:var(--text-dim)">Calcul√© sur ${db.history.length} documents enregistr√©s.</p></div>`;
}

/* --- 3. MODULE URSSAF --- */
function renderUrssaf(c) {
    c.innerHTML = `<div class="pro-card"><h4>Calculateur Charges</h4><input type="number" id="ca-input" placeholder="CA HT Global" oninput="document.getElementById('tax-res').innerText = (this.value*0.212).toFixed(2) + ' ‚Ç¨'"><div style="display:flex; justify-content:space-between; margin-top:15px;"><span>Cotisations (21,2%) :</span><b id="tax-res">0.00 ‚Ç¨</b></div></div>`;
}

/* --- 4. MODULE HISTORIQUE --- */
function renderHistory(c) {
    c.innerHTML = `<div class="pro-card"><h4>Archives Documents</h4><div id="h-list">${db.history.reverse().map((doc, i) => `<div class="list-item"><div><b>${doc.num}</b><br><small>${doc.client}</small></div><div><b>${doc.totalHT.toFixed(2)}‚Ç¨</b></div></div>`).join('')}</div></div>`;
}

/* --- 5. MODULE ACQUITT√âE --- */
function renderAcquit(c) {
    c.innerHTML = `<div class="pro-card"><h4>Import PDF Facture</h4><p style="font-size:12px; color:var(--text-dim); margin-bottom:15px;">Ajoute un tampon rouge "ACQUITT√âE" sur un fichier existant.</p><input type="file" id="pdf-up" accept="application/pdf" style="padding:40px; border:2px dashed var(--border); text-align:center;"><button class="btn-mse" style="width:100%; margin-top:15px;" onclick="processPdf()">TAMPONNER & SAUVER</button></div>`;
}
async function processPdf() {
    const f = document.getElementById('pdf-up').files[0];
    if(!f) return;
    const r = new FileReader();
    r.onload = async function() {
        const b = new Uint8Array(this.result);
        const doc = await PDFLib.PDFDocument.load(b);
        const page = doc.getPages()[0];
        const {width, height} = page.getSize();
        page.drawText('ACQUITT√âE', {x: width-180, y: height-100, size: 28, color: PDFLib.rgb(0.8,0.2,0.2), rotate: PDFLib.degrees(-15)});
        const out = await doc.save();
        const bl = new Blob([out], {type:"application/pdf"});
        const l = document.createElement("a"); l.href = URL.createObjectURL(bl); l.download = "MSE_Acquittee.pdf"; l.click();
    };
    r.readAsArrayBuffer(f);
}

/* --- 6. √âDITEUR DEVIS/FACTURE --- */
function renderEditor(c) {
    const today = new Date().toISOString().split('T')[0];
    c.innerHTML = `
        <div class="pro-card"><h4>üìÅ Admin & Dates</h4>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <div><label style="font-size:10px; color:var(--text-dim)">√âMISSION</label><input type="date" id="d-emit" value="${today}"></div>
                <div><label style="font-size:10px; color:var(--text-dim)">√âCH√âANCE</label><input type="date" id="d-due" value="${today}"></div>
            </div>
            <input type="text" id="d-siret" value="${USER.siren}" placeholder="SIRET">
            <input type="text" id="d-dec" value="${USER.decennale}" placeholder="D√©cennale">
        </div>
        <div class="pro-card"><h4>üë§ Client</h4>
            <select id="c-select" onchange="fillClient(this.value)"><option value="">Choisir un client enregistr√©...</option>${db.clients.map((cli, i) => `<option value="${i}">${cli.name}</option>`).join('')}</select>
            <input id="c-name" placeholder="Nom complet"><textarea id="c-addr" placeholder="Adresse" rows="2"></textarea>
            <input id="doc-num" placeholder="Num√©ro Document">
            <input id="doc-obj" placeholder="Objet de l'intervention">
        </div>
        ${curMode==='premium' ? `<div class="pro-card"><h4>‚öôÔ∏è Fiscalit√©</h4><select id="tva-rate" onchange="updateCalc()"><option value="20">20% Normal</option><option value="10">10% R√©duit</option><option value="5.5">5.5% R√©nov</option></select></div>` : ''}
        <div class="pro-card"><h4>üõ†Ô∏è Lignes</h4><div id="lines"></div><button onclick="addLine()" style="background:none; border:1px dashed var(--border); color:var(--text); padding:15px; width:100%; border-radius:20px;">+ AJOUTER LIGNE</button></div>`;
    addLine();
}
function fillClient(i) { if(i==="") return; const c = db.clients[i]; document.getElementById('c-name').value = c.name; document.getElementById('c-addr').value = c.addr; }
function addLine(){
    const id = Date.now();
    const div = document.createElement('div'); div.className = 'line-item'; div.id = 'l-'+id;
    div.innerHTML = `<input type="text" class="l-t" placeholder="Prestation (Titre)" style="font-weight:900;"><textarea class="l-d" placeholder="Description (Italique)" rows="1" style="font-style:italic; font-weight:300; opacity:0.7; border:none;"></textarea>
    <div style="display:flex; gap:10px; margin-top:10px;"><input type="number" class="l-q" value="1" style="flex:1" oninput="updateCalc()"><input type="number" class="l-p" placeholder="Prix" style="flex:2" oninput="updateCalc()" inputmode="decimal">
    <button onclick="document.getElementById('l-${id}').remove(); updateCalc();" style="border:none; background:none; color:var(--mse-red); font-size:24px;">‚úï</button></div>`;
    document.getElementById('lines').appendChild(div);
}
function updateCalc(){
    let raw = 0; document.querySelectorAll('.line-item').forEach(l => { raw += (l.querySelector('.l-q').value * l.querySelector('.l-p').value); });
    const rate = curMode === 'premium' ? parseFloat(document.getElementById('tva-rate')?.value || 20) : 0;
    const final = raw * (1 + rate/100);
    document.getElementById('dock-total').innerText = final.toFixed(2) + ' ‚Ç¨';
    return { raw, final, rate };
}

function generatePreview(){
    const data = updateCalc();
    const isPremium = (curMode === 'premium');
    const dateE = new Date(document.getElementById('d-emit').value).toLocaleDateString('fr-FR');
    const dateH = new Date(document.getElementById('d-due').value).toLocaleDateString('fr-FR');
    
    // Save to History
    db.history.push({num: document.getElementById('doc-num').value, client: document.getElementById('c-name').value, totalHT: data.raw, date: dateE});
    localStorage.setItem('mse_history', JSON.stringify(db.history));

    let rows = "";
    document.querySelectorAll('.line-item').forEach(l => {
        rows += `<tr><td style="padding:15px 10px; border-bottom:1px solid #eee;"><div style="font-weight:900; font-size:14px;">${l.querySelector('.l-t').value}</div><div style="font-style:italic; font-size:10px; color:#666;">${l.querySelector('.l-d').value}</div></td><td style="text-align:center;">${l.querySelector('.l-q').value}</td><td style="text-align:right;">${parseFloat(l.querySelector('.l-p').value).toFixed(2)}‚Ç¨</td><td style="text-align:right;">${(l.querySelector('.l-q').value * l.querySelector('.l-p').value).toFixed(2)}‚Ç¨</td>${isPremium?`<td>${data.rate}%</td>`:''}</tr>`;
    });

    document.getElementById('pdf-paper').innerHTML = `
    <div style="padding:45px; position:relative; color:#000; background:#fff; font-family:Arial;">
        <div style="display:flex; justify-content:space-between; border-bottom:2px solid #eee; padding-bottom:30px;">
            <div style="width:55%;"><img src="logo.png" style="max-width:320px; max-height:140px;" onerror="this.style.display='none'">
            <div style="font-size:12px; color:#555; margin-top:15px;"><strong>${USER.name}</strong><br>${USER.addr}<br>SIRET: ${document.getElementById('d-siret').value}<br>${document.getElementById('d-dec').value}</div></div>
            <div style="background:#f8f8f8; padding:20px; width:44%; border-left:5px solid #333;"><strong>Facturer √† :</strong><br><br><strong>${document.getElementById('c-name').value}</strong><br>${document.getElementById('c-addr').value.replace(/\n/g,'<br>')}</div>
        </div>
        <div style="display:flex; justify-content:space-between; border-bottom:4px solid #D32F2F; margin: 30px 0 20px; padding-bottom:15px;">
            <div><h1 style="margin:0; font-size:24px;">${curType} N¬∞ ${document.getElementById('doc-num').value}</h1><div style="color:#D32F2F; font-weight:bold;">Objet : ${document.getElementById('doc-obj').value}</div></div>
            <div style="text-align:right; font-size:11px;"><strong>Date d'√©mission :</strong> ${dateE}<br><strong>Validit√© :</strong> ${dateH}</div>
        </div>
        <table style="width:100%; border-collapse:collapse; font-size:12px;">
            <thead><tr style="background:#333; color:#fff;"><th style="text-align:left; padding:10px;">D√©signation</th><th>Qt√©</th><th>P.U</th><th>Total</th>${isPremium?'<th>TVA</th>':''}</tr></thead>
            <tbody>${rows}</tbody>
        </table>
        <div style="display:flex; justify-content:flex-end; margin-top:30px;">
            <table style="width:300px; text-align:right; font-size:14px;">
                <tr><td>Total ${isPremium?'HT':'NET'}</td><td>${data.raw.toFixed(2)} ‚Ç¨</td></tr>
                ${isPremium ? `<tr><td>TVA (${data.rate}%)</td><td>${(data.final - data.raw).toFixed(2)} ‚Ç¨</td></tr>` : ''}
                <tr style="font-size:20px; font-weight:900; color:#D32F2F; border-top:2px solid #000;"><td>${isPremium?'TOTAL TTC':'MONTANT NET'}</td><td>${data.final.toFixed(2)} ‚Ç¨</td></tr>
            </table>
        </div>
        <div style="margin-top:80px; border-top:1px solid #ddd; padding-top:20px; font-size:11px;">IBAN : ${USER.iban}<br>BIC : ${USER.bic}<br><br><div style="text-align:right;">Signature et cachet</div></div>
    </div>`;
    document.getElementById('preview-overlay').style.display = 'flex';
}

function downloadPDF(){
    const el = document.getElementById('pdf-paper');
    html2pdf().set({ margin:0, filename:`MSE_${curType}.pdf`, html2canvas:{scale:3, useCORS:true}, jsPDF:{unit:'mm', format:'a4'} }).from(el).save();
}
</script>
</body>
</html>
